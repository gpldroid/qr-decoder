<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>أدوات QR وباركود برو — نسخة مشابهة</title>
  <style>
    :root{
      --bg:#0f1320; --card:#171b2e; --accent:#4cc9f0; --text:#e6e9f3; --muted:#9aa3b2;
      --ok:#2ecc71; --warn:#f39c12; --err:#e74c3c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",Tahoma,Arial;
      background:linear-gradient(120deg,#0f1320 0%,#141a2c 60%,#0f1320 100%);
      color:var(--text);
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px 20px; border-bottom:1px solid #20263d; backdrop-filter:saturate(1.2);
      position:sticky; top:0; z-index:10; background:#11162aee;
    }
    header .brand{display:flex; align-items:center; gap:10px; font-weight:700}
    header .brand .logo{
      width:36px; height:36px; border-radius:8px; background:conic-gradient(from 180deg,var(--accent),#8a4cff);
      box-shadow:0 0 24px #4cc9f066;
    }
    header .actions{display:flex; gap:8px; align-items:center}
    .btn{
      padding:10px 14px; border:1px solid #273253; background:#11162a; color:var(--text);
      border-radius:10px; cursor:pointer; transition:.2s ease; font-weight:600;
    }
    .btn:hover{border-color:#3a4a78; background:#151c33}
    .btn.primary{background:linear-gradient(90deg,#4cc9f0,#8a4cff); border:none; color:#0d1020}
    .grid{
      display:grid; grid-template-columns:1fr 1fr; gap:16px; padding:20px; max-width:1200px; margin:0 auto;
    }
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card); border:1px solid #232a45; border-radius:16px; overflow:hidden;
      box-shadow:0 10px 30px #00000040;
    }
    .card header{
      position:static; background:transparent; border-bottom:1px solid #232a45;
      padding:14px 16px; display:flex; justify-content:space-between; align-items:center;
    }
    .card header h2{margin:0; font-size:18px}
    .card header small{color:var(--muted)}
    .card .content{padding:16px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end}
    .field{flex:1; min-width:220px}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input,select,textarea{
      width:100%; background:#0e1326; color:var(--text); border:1px solid #263051;
      border-radius:10px; padding:10px 12px; outline:none; transition:.2s ease;
    }
    input:focus,select:focus,textarea:focus{border-color:#3f54a6}
    textarea{min-height:90px; resize:vertical}
    .hr{border-top:1px dashed #2a3356; margin:14px 0}
    .preview{
      background:#0d1224; border:1px dashed #2a3356; border-radius:12px; padding:12px; display:flex; gap:12px; flex-wrap:wrap;
    }
    video,canvas,img{max-width:100%; border-radius:12px}
    .status{padding:8px 10px; border-radius:10px; background:#0d1224; border:1px solid #263051; color:var(--muted)}
    .status.ok{color:#c8f7dc; border-color:#2ecc71}
    .status.warn{color:#ffe5b3; border-color:#f39c12}
    .status.err{color:#ffd0d0; border-color:#e74c3c}
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;
      background:#0d1224; border:1px solid #263051; color:var(--muted); font-size:13px
    }
    .footer{max-width:1200px; margin:20px auto; padding:0 20px 30px; color:#8d95a8}
    .lang-toggle{display:flex; gap:8px}
    .hidden{display:none !important}
    .flex-gap{display:flex; gap:8px; flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div id="brandTitle" data-ar="أدوات QR وباركود برو" data-en="QR & Barcode Pro Tools">أدوات QR وباركود برو</div>
        <small id="brandSub" data-ar="نسخة مبسطة بدون مكتبات خارجية" data-en="Simplified build without external libraries">نسخة مبسطة بدون مكتبات خارجية</small>
      </div>
    </div>
    <div class="actions">
      <div class="lang-toggle">
        <button class="btn" id="btnAr">العربية</button>
        <button class="btn" id="btnEn">English</button>
      </div>
      <button class="btn primary" id="shareBtn">شارك</button>
    </div>
  </header>

  <main class="grid">
    <!-- Scanner card -->
    <section class="card" id="scanCard">
      <header>
        <h2 id="scanTitle" data-ar="أداة الفحص" data-en="Scanner tool">أداة الفحص</h2>
        <small id="scanHint" data-ar="استخدم الكاميرا أو ارفع صورة" data-en="Use camera or upload an image">استخدم الكاميرا أو ارفع صورة</small>
      </header>
      <div class="content">
        <div class="row">
          <div class="flex-gap">
            <button class="btn" id="startCamBtn" data-ar="بدء الكاميرا" data-en="Start camera">بدء الكاميرا</button>
            <button class="btn" id="stopCamBtn" data-ar="إيقاف" data-en="Stop">إيقاف</button>
            <label class="pill">
              <input type="file" id="fileInput" accept="image/*" style="display:none" />
              <span id="uploadLabel" data-ar="رفع صورة..." data-en="Upload image...">رفع صورة...</span>
            </label>
            <span class="pill" id="supportBadge"></span>
          </div>
          <div class="field" style="max-width:220px">
            <label id="cameraSelectLbl" data-ar="اختيار الكاميرا" data-en="Camera source">اختيار الكاميرا</label>
            <select id="cameraSelect"></select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="preview">
          <div style="flex:1; min-width:280px">
            <video id="video" playsinline muted></video>
          </div>
          <div style="flex:1; min-width:280px">
            <canvas id="canvas" class="hidden"></canvas>
            <img id="uploadedImg" class="hidden" alt="">
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="field">
            <div class="status" id="scanStatus">جاهز للمسح…</div>
          </div>
          <div class="flex-gap">
            <button class="btn" id="snapBtn" data-ar="التقاط إطار" data-en="Capture frame">التقاط إطار</button>
            <button class="btn" id="detectBtn" data-ar="فك التشفير" data-en="Decode">فك التشفير</button>
            <button class="btn" id="clearScanBtn" data-ar="مسح النتائج" data-en="Clear results">مسح النتائج</button>
          </div>
        </div>

        <div class="hr"></div>

        <div id="scanResults"></div>
      </div>
    </section>

    <!-- Generator card -->
    <section class="card" id="genCard">
      <header>
        <h2 id="genTitle" data-ar="أداة الإنشاء" data-en="Generator tool">أداة الإنشاء</h2>
        <small id="genHint" data-ar="أنشئ رموز QR بمختلف الأنواع" data-en="Create QR codes for many types">أنشئ رموز QR بمختلف الأنواع</small>
      </header>
      <div class="content">
        <div class="row">
          <div class="field" style="max-width:280px">
            <label id="typeLbl" data-ar="النوع" data-en="Type">النوع</label>
            <select id="qrType">
              <option value="url">URL</option>
              <option value="text">Text</option>
              <option value="wifi">Wi‑Fi</option>
              <option value="vcard">VCard</option>
              <option value="whatsapp">WhatsApp</option>
              <option value="email">Email</option>
            </select>
          </div>

          <div class="field" style="max-width:220px">
            <label id="sizeLbl" data-ar="الحجم" data-en="Size">الحجم</label>
            <input type="number" id="qrSize" min="120" max="800" step="20" value="320" />
          </div>

          <div class="field" style="max-width:220px">
            <label id="fgLbl" data-ar="لون المقدمة" data-en="Foreground">لون المقدمة</label>
            <input type="color" id="qrFg" value="#000000" />
          </div>

          <div class="field" style="max-width:220px">
            <label id="bgLbl" data-ar="لون الخلفية" data-en="Background">لون الخلفية</label>
            <input type="color" id="qrBg" value="#ffffff" />
          </div>

          <div class="field" style="max-width:220px">
            <label id="qualityLbl" data-ar="الجودة" data-en="Quality">الجودة</label>
            <input type="range" id="qrQuality" min="0.5" max="1.0" step="0.1" value="0.9" />
          </div>
        </div>

        <div id="typeForms" class="content">
          <!-- Dynamic fields container -->
        </div>

        <div class="row">
          <div class="flex-gap">
            <button class="btn primary" id="generateBtn" data-ar="إنشاء" data-en="Generate">إنشاء</button>
            <button class="btn" id="downloadBtn" data-ar="تنزيل PNG" data-en="Download PNG">تنزيل PNG</button>
            <button class="btn" id="clearGenBtn" data-ar="مسح" data-en="Clear">مسح</button>
          </div>
          <div class="field">
            <div class="status" id="genStatus">جاهز للإنشاء…</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="preview">
          <canvas id="qrCanvas" width="320" height="320"></canvas>
          <img id="qrImg" alt="" class="hidden">
        </div>
      </div>
    </section>
  </main>

  <div class="footer">
    <div id="footNote" data-ar="قد تختلف دقة الفحص حسب جودة الصورة ودعم المتصفح لـ BarcodeDetector."
         data-en="Scanning accuracy depends on image quality and browser support for BarcodeDetector.">
      قد تختلف دقة الفحص حسب جودة الصورة ودعم المتصفح لـ BarcodeDetector.
    </div>
  </div>

  <script>
    // --- Language toggle ---
    const lang = { current: 'ar' };
    const setLang = (l) => {
      lang.current = l;
      document.documentElement.lang = l;
      document.documentElement.dir = l === 'ar' ? 'rtl' : 'ltr';
      document.querySelectorAll('[data-ar]').forEach(el=>{
        el.textContent = l==='ar' ? el.getAttribute('data-ar') : el.getAttribute('data-en');
      });
    };
    document.getElementById('btnAr').onclick = ()=> setLang('ar');
    document.getElementById('btnEn').onclick = ()=> setLang('en');
    setLang('ar');

    // --- Share button (optional) ---
    const shareBtn = document.getElementById('shareBtn');
    shareBtn.onclick = async ()=>{
      const title = document.getElementById('brandTitle').textContent;
      try{
        if(navigator.share){
          await navigator.share({title, text:title, url:location.href});
        }else{
          alert(lang.current==='ar' ? 'مشاركة غير مدعومة على هذا المتصفح' : 'Share not supported on this browser');
        }
      }catch(e){}
    };

    // --- Scanner logic ---
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const scanStatus = document.getElementById('scanStatus');
    const scanResults = document.getElementById('scanResults');
    const uploadImg = document.getElementById('uploadedImg');
    const fileInput = document.getElementById('fileInput');
    const cameraSelect = document.getElementById('cameraSelect');
    const supportBadge = document.getElementById('supportBadge');

    let stream = null;
    let detector = null;
    const supported = ('BarcodeDetector' in window);
    supportBadge.textContent = supported
      ? (lang.current==='ar' ? 'مدعوم: BarcodeDetector' : 'Supported: BarcodeDetector')
      : (lang.current==='ar' ? 'غير مدعوم: سيتم استخدام بدائل' : 'Not supported: fallback in use');

    const listCameras = async ()=>{
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const vids = devices.filter(d=>d.kind==='videoinput');
        cameraSelect.innerHTML = '';
        vids.forEach((d, i)=>{
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || (lang.current==='ar' ? `كاميرا ${i+1}` : `Camera ${i+1}`);
          cameraSelect.appendChild(opt);
        });
      }catch(e){}
    };

    const startCamera = async ()=>{
      try{
        await listCameras();
        const deviceId = cameraSelect.value || undefined;
        stream = await navigator.mediaDevices.getUserMedia({
          video: deviceId ? {deviceId: {exact: deviceId}} : {facingMode:'environment'},
          audio:false
        });
        video.srcObject = stream;
        await video.play();
        scanStatus.className = 'status ok';
        scanStatus.textContent = lang.current==='ar' ? 'الكاميرا تعمل' : 'Camera running';
        canvas.classList.add('hidden');
        uploadImg.classList.add('hidden');
        if(supported){
          detector = new BarcodeDetector({formats:['qr_code','ean_13','ean_8','upc_a','upc_e','code_128','code_39']});
        }else{
          detector = null; // fallback manual snapshot decode (limited)
        }
      }catch(e){
        scanStatus.className = 'status err';
        scanStatus.textContent = lang.current==='ar' ? 'تعذر بدء الكاميرا' : 'Failed to start camera';
      }
    };

    const stopCamera = ()=>{
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        video.srcObject = null;
      }
      scanStatus.className = 'status';
      scanStatus.textContent = lang.current==='ar' ? 'تم إيقاف الكاميرا' : 'Camera stopped';
    };

    document.getElementById('startCamBtn').onclick = startCamera;
    document.getElementById('stopCamBtn').onclick = stopCamera;
    document.getElementById('snapBtn').onclick = ()=>{
      if(!video.srcObject){
        scanStatus.className = 'status warn';
        scanStatus.textContent = lang.current==='ar' ? 'شغّل الكاميرا أولًا' : 'Start camera first';
        return;
      }
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      canvas.classList.remove('hidden');
      uploadImg.classList.add('hidden');
      scanStatus.className = 'status';
      scanStatus.textContent = lang.current==='ar' ? 'تم التقاط الإطار' : 'Frame captured';
    };

    fileInput.onchange = ()=>{
      const f = fileInput.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      uploadImg.src = url;
      uploadImg.onload = ()=>{
        canvas.width = uploadImg.naturalWidth;
        canvas.height = uploadImg.naturalHeight;
        ctx.drawImage(uploadImg,0,0);
        canvas.classList.remove('hidden');
        uploadImg.classList.remove('hidden');
        URL.revokeObjectURL(url);
        scanStatus.className = 'status';
        scanStatus.textContent = lang.current==='ar' ? 'تم تحميل الصورة' : 'Image loaded';
      };
    };
    document.getElementById('uploadLabel').onclick = ()=> fileInput.click();

    const renderDetections = (codes=[])=>{
      scanResults.innerHTML = '';
      if(!codes.length){
        const p = document.createElement('div');
        p.className='status warn';
        p.textContent = lang.current==='ar' ? 'لا توجد نتائج' : 'No results';
        scanResults.appendChild(p);
        return;
      }
      codes.forEach(code=>{
        const block = document.createElement('div');
        block.className='status ok';
        const txt = [
          (lang.current==='ar' ? 'النوع: ' : 'Type: ') + (code.format || 'qr_code'),
          (lang.current==='ar' ? 'القيمة: ' : 'Value: ') + (code.rawValue || code.data || '')
        ].join(' | ');
        block.textContent = txt;
        scanResults.appendChild(block);
      });
    };

    const detect = async ()=>{
      try{
        if(!canvas.width || !canvas.height){
          scanStatus.className = 'status warn';
          scanStatus.textContent = lang.current==='ar' ? 'التقط إطارًا أو ارفع صورة أولًا' : 'Capture a frame or upload an image first';
          return;
        }
        let results = [];
        if(detector){
          results = await detector.detect(canvas);
          // normalize
          results = results.map(r=>({format:r.format, rawValue:r.rawValue}));
        }else{
          // Fallback: try simple luminance threshold and look for QR-like finder (very limited)
          // This is a placeholder; real decoding needs native support or a QR library.
          results = [];
        }
        renderDetections(results);
        scanStatus.className = results.length ? 'status ok' : 'status warn';
        scanStatus.textContent = results.length
          ? (lang.current==='ar' ? 'تم فك التشفير' : 'Decoded')
          : (lang.current==='ar' ? 'لم يتم التعرف على رمز' : 'No code recognized');
      }catch(e){
        scanStatus.className = 'status err';
        scanStatus.textContent = lang.current==='ar' ? 'حدث خطأ أثناء الفحص' : 'Error during detection';
      }
    };
    document.getElementById('detectBtn').onclick = detect;
    document.getElementById('clearScanBtn').onclick = ()=>{
      scanResults.innerHTML='';
      scanStatus.className='status';
      scanStatus.textContent = lang.current==='ar' ? 'جاهز للمسح…' : 'Ready to scan…';
    };
    cameraSelect.onchange = ()=>{
      if(stream) stopCamera();
      startCamera();
    };

    // --- Generator logic ---
    const qrCanvas = document.getElementById('qrCanvas');
    const qctx = qrCanvas.getContext('2d', {willReadFrequently:true});
    const qrImg = document.getElementById('qrImg');
    const genStatus = document.getElementById('genStatus');
    const typeForms = document.getElementById('typeForms');
    const qrType = document.getElementById('qrType');
    const qrSize = document.getElementById('qrSize');
    const qrFg = document.getElementById('qrFg');
    const qrBg = document.getElementById('qrBg');
    const qrQuality = document.getElementById('qrQuality');

    const formTemplates = {
      url: (l)=> `
        <div class="row">
          <div class="field"><label>${l==='ar'?'الرابط':'URL'}</label><input id="f_url" placeholder="https://example.com"></div>
        </div>`,
      text: (l)=> `
        <div class="row">
          <div class="field"><label>${l==='ar'?'النص':'Text'}</label><textarea id="f_text" placeholder="${l==='ar'?'اكتب النص هنا':'Enter text'}"></textarea></div>
        </div>`,
      wifi: (l)=> `
        <div class="row">
          <div class="field"><label>${l==='ar'?'اسم الشبكة (SSID)':'SSID'}</label><input id="f_ssid" placeholder="MyWiFi"></div>
          <div class="field"><label>${l==='ar'?'كلمة المرور':'Password'}</label><input id="f_pass" placeholder="••••••••"></div>
          <div class="field"><label>${l==='ar'?'التشفير':'Encryption'}</label>
            <select id="f_auth"><option>WPA</option><option>WEP</option><option>nopass</option></select>
          </div>
          <div class="field"><label>${l==='ar'?'مخفي':'Hidden'}</label>
            <select id="f_hidden"><option value="false">${l==='ar'?'لا':'No'}</option><option value="true">${l==='ar'?'نعم':'Yes'}</option></select>
          </div>
        </div>`,
      vcard: (l)=> `
        <div class="row">
          <div class="field"><label>${l==='ar'?'الاسم الكامل':'Full name'}</label><input id="f_fn" placeholder="Jane Doe"></div>
          <div class="field"><label>${l==='ar'?'الهاتف':'Phone'}</label><input id="f_tel" placeholder="+212..."></div>
          <div class="field"><label>${l==='ar'?'البريد':'Email'}</label><input id="f_email" placeholder="jane@example.com"></div>
          <div class="field"><label>${l==='ar'?'الشركة':'Org'}</label><input id="f_org" placeholder="Company"></div>
          <div class="field"><label>${l==='ar'?'المسمى الوظيفي':'Title'}</label><input id="f_title" placeholder="Role"></div>
        </div>`,
      whatsapp: (l)=> `
        <div class="row">
          <div class="field"><label>${l==='ar'?'رقم الهاتف':'Phone'}</label><input id="f_waphone" placeholder="+212..."></div>
          <div class="field"><label>${l==='ar'?'الرسالة':'Message'}</label><input id="f_wamsg" placeholder="${l==='ar'?'نص الرسالة':'Message text'}"></div>
        </div>`,
      email: (l)=> `
        <div class="row">
          <div class="field"><label>${l==='ar'?'العنوان':'To'}</label><input id="f_to" placeholder="user@example.com"></div>
          <div class="field"><label>${l==='ar'?'الموضوع':'Subject'}</label><input id="f_sub" placeholder="${l==='ar'?'موضوع البريد':'Subject'}"></div>
          <div class="field"><label>${l==='ar'?'المحتوى':'Body'}</label><textarea id="f_body" placeholder="${l==='ar'?'نص الرسالة':'Email body'}"></textarea></div>
        </div>`
    };

    const renderTypeForm = ()=>{
      typeForms.innerHTML = formTemplates[qrType.value](lang.current);
    };
    renderTypeForm();
    qrType.onchange = renderTypeForm;

    const buildPayload = ()=>{
      switch(qrType.value){
        case 'url': return document.getElementById('f_url').value.trim();
        case 'text': return document.getElementById('f_text').value;
        case 'wifi': {
          const ssid = document.getElementById('f_ssid').value;
          const pass = document.getElementById('f_pass').value;
          const auth = document.getElementById('f_auth').value;
          const hidden = document.getElementById('f_hidden').value === 'true';
          return `WIFI:T:${auth};S:${ssid};P:${pass};H:${hidden};;`;
        }
        case 'vcard': {
          const fn = document.getElementById('f_fn').value;
          const tel = document.getElementById('f_tel').value;
          const email = document.getElementById('f_email').value;
          const org = document.getElementById('f_org').value;
          const title = document.getElementById('f_title').value;
          return `BEGIN:VCARD
VERSION:3.0
FN:${fn}
TEL:${tel}
EMAIL:${email}
ORG:${org}
TITLE:${title}
END:VCARD`;
        }
        case 'whatsapp': {
          const phone = document.getElementById('f_waphone').value.replace(/\D/g,'');
          const msg = encodeURIComponent(document.getElementById('f_wamsg').value || '');
          return `https://wa.me/${phone}?text=${msg}`;
        }
        case 'email': {
          const to = document.getElementById('f_to').value;
          const sub = encodeURIComponent(document.getElementById('f_sub').value || '');
          const body = encodeURIComponent(document.getElementById('f_body').value || '');
          return `mailto:${to}?subject=${sub}&body=${body}`;
        }
      }
      return '';
    };

    // Minimal generator using external-free approach:
    // Note: True QR encoding is complex. Here we call a public QR service for PNG generation,
    // then recolor it on canvas according to chosen fg/bg and quality.
    async function generateQR(){
      try{
        const payload = buildPayload();
        if(!payload){
          genStatus.className='status warn';
          genStatus.textContent = lang.current==='ar' ? 'أدخل البيانات أولًا' : 'Enter data first';
          return;
        }
        const size = Math.max(120, Math.min(800, parseInt(qrSize.value||320,10)));
        qrCanvas.width = size;
        qrCanvas.height = size;
        // Fetch PNG from a public endpoint
        const url = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(payload)}`;
        const resp = await fetch(url);
        const blob = await resp.blob();
        const imgUrl = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = ()=>{
          // Draw base
          qctx.imageSmoothingQuality = 'high';
          qctx.imageSmoothingEnabled = true;
          qctx.fillStyle = qrBg.value;
          qctx.fillRect(0,0,size,size);
          qctx.drawImage(img,0,0,size,size);
          URL.revokeObjectURL(imgUrl);

          // Optional recolor: sample pixels, map black to fg, white to bg (approx)
          const imageData = qctx.getImageData(0,0,size,size);
          const data = imageData.data;
          const [fr,fgc,fb] = hexToRgb(qrFg.value);
          const [br,bg,bgb] = hexToRgb(qrBg.value);
          for(let i=0;i<data.length;i+=4){
            const v = (data[i]+data[i+1]+data[i+2])/3;
            if(v<128){ // dark -> fg
              data[i]=fr; data[i+1]=fgc; data[i+2]=fb;
            }else{ // light -> bg
              data[i]=br; data[i+1]=bg; data[i+2]=bgb;
            }
            data[i+3] = Math.round(255 * parseFloat(qrQuality.value||0.9));
          }
          qctx.putImageData(imageData,0,0);

          qrImg.src = qrCanvas.toDataURL('image/png');
          qrImg.classList.remove('hidden');
          genStatus.className='status ok';
          genStatus.textContent = lang.current==='ar' ? 'تم إنشاء الرمز' : 'QR generated';
        };
        img.onerror = ()=>{
          genStatus.className='status err';
          genStatus.textContent = lang.current==='ar' ? 'فشل إنشاء الرمز' : 'Failed to generate';
        };
        img.src = imgUrl;
      }catch(e){
        genStatus.className='status err';
        genStatus.textContent = lang.current==='ar' ? 'حدث خطأ أثناء الإنشاء' : 'Error during generation';
      }
    }

    function hexToRgb(hex){
      const h = hex.replace('#','');
      const bigint = parseInt(h,16);
      if(h.length===6) return [(bigint>>16)&255, (bigint>>8)&255, bigint&255];
      // short #abc
      return [ ((bigint>>8)&15)*17, ((bigint>>4)&15)*17, (bigint&15)*17 ];
    }

    document.getElementById('generateBtn').onclick = generateQR;
    document.getElementById('downloadBtn').onclick = ()=>{
      const a = document.createElement('a');
      a.download = 'qr.png';
      a.href = qrCanvas.toDataURL('image/png');
      a.click();
    };
    document.getElementById('clearGenBtn').onclick = ()=>{
      qctx.clearRect(0,0,qrCanvas.width,qrCanvas.height);
      qrImg.classList.add('hidden');
      genStatus.className='status';
      genStatus.textContent = lang.current==='ar' ? 'جاهز للإنشاء…' : 'Ready to generate…';
    };
  </script>
</body>
</html>
