<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>أدوات QR وباركود برو — إصدار متقدم محلي</title>
  <style>
    :root{
      --bg:#0e1222; --card:#161b2f; --line:#232a45; --accent:#4cc9f0; --accent2:#8a4cff;
      --text:#e7eaf5; --muted:#98a2b3; --ok:#2ecc71; --warn:#f39c12; --err:#e74c3c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",Tahoma,Arial;
      background:radial-gradient(1000px 500px at 10% 10%, #111737 0%, #0e1222 60%),
                 radial-gradient(800px 400px at 90% 10%, #1b2044 0%, #0e1222 70%);
      color:var(--text);
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px 20px; border-bottom:1px solid var(--line); position:sticky; top:0; z-index:10; background:#0e1222e6; backdrop-filter:saturate(1.2);
    }
    header .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:36px; height:36px; border-radius:10px; background:conic-gradient(from 200deg, var(--accent), var(--accent2));
      box-shadow:0 0 24px #4cc9f066;
    }
    .brand h1{margin:0; font-size:18px}
    .brand small{display:block; color:var(--muted)}
    .actions{display:flex; align-items:center; gap:8px}
    .btn{
      padding:10px 14px; border:1px solid var(--line); background:#101631; color:var(--text);
      border-radius:10px; cursor:pointer; transition:.2s ease; font-weight:600;
    }
    .btn:hover{border-color:#3a4a78; background:#151c33}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2)); border:none; color:#0d1020}
    .grid{
      display:grid; grid-template-columns:1fr 1fr; gap:16px; max-width:1200px; margin:0 auto; padding:20px;
    }
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:16px; overflow:hidden; box-shadow:0 10px 30px #00000040;
    }
    .card > header{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line)}
    .card h2{margin:0; font-size:18px}
    .card small{color:var(--muted)}
    .content{padding:16px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end}
    .field{flex:1; min-width:220px}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input,select,textarea{
      width:100%; background:#0d1328; color:var(--text); border:1px solid #25305a; border-radius:10px; padding:10px 12px; outline:none; transition:.2s ease;
    }
    input:focus,select:focus,textarea:focus{border-color:#4b62a8}
    textarea{min-height:90px; resize:vertical}
    .hr{border-top:1px dashed #2a3356; margin:14px 0}
    .preview{background:#0d1224; border:1px dashed #2a3356; border-radius:12px; padding:12px; display:flex; gap:12px; flex-wrap:wrap;}
    video,canvas,img{max-width:100%; border-radius:12px}
    .status{padding:8px 10px; border-radius:10px; background:#0d1224; border:1px solid #263051; color:var(--muted)}
    .status.ok{color:#c8f7dc; border-color:var(--ok)}
    .status.warn{color:#ffe5b3; border-color:var(--warn)}
    .status.err{color:#ffd0d0; border-color:var(--err)}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; background:#0d1224; border:1px solid #263051; color:var(--muted); font-size:13px}
    .footer{max-width:1200px; margin:20px auto; padding:0 20px 30px; color:#8d95a8}
    .hidden{display:none !important}
    .flex-gap{display:flex; gap:8px; flex-wrap:wrap}
    .split{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:640px){.split{grid-template-columns:1fr}}
    .badges{display:flex; gap:8px; flex-wrap:wrap}
    .badge{padding:6px 10px; border-radius:999px; border:1px solid #263051; background:#0d1224; color:#8d95a8; font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1 id="brandTitle" data-ar="أدوات QR وباركود برو" data-en="QR & Barcode Pro Tools">أدوات QR وباركود برو</h1>
        <small id="brandSub" data-ar="إصدار محلي متقدم — QR + باركود" data-en="Advanced local build — QR + Barcode">إصدار محلي متقدم — QR + باركود</small>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="btnAr">العربية</button>
      <button class="btn" id="btnEn">English</button>
      <button class="btn primary" id="shareBtn">شارك</button>
    </div>
  </header>

  <main class="grid">
    <!-- Scanner -->
    <section class="card" id="scanCard">
      <header>
        <h2 id="scanTitle" data-ar="أداة الفحص" data-en="Scanner tool">أداة الفحص</h2>
        <small id="scanHint" data-ar="الكاميرا أو صورة مرفوعة + فك متقدم" data-en="Camera or uploaded image + advanced decode">الكاميرا أو صورة مرفوعة + فك متقدم</small>
      </header>
      <div class="content">
        <div class="row">
          <div class="flex-gap">
            <button class="btn" id="startCamBtn" data-ar="بدء الكاميرا" data-en="Start camera">بدء الكاميرا</button>
            <button class="btn" id="stopCamBtn" data-ar="إيقاف" data-en="Stop">إيقاف</button>
            <label class="pill">
              <input type="file" id="fileInput" accept="image/*" style="display:none"/>
              <span id="uploadLabel" data-ar="رفع صورة..." data-en="Upload image...">رفع صورة...</span>
            </label>
          </div>
          <div class="field" style="max-width:260px">
            <label id="cameraSelectLbl" data-ar="اختيار الكاميرا" data-en="Camera source">اختيار الكاميرا</label>
            <select id="cameraSelect"></select>
          </div>
          <div class="field" style="max-width:220px">
            <label id="scanTypeLbl" data-ar="نوع الفحص" data-en="Scan type">نوع الفحص</label>
            <select id="scanType">
              <option value="auto">Auto (QR + Barcode)</option>
              <option value="qr">QR only</option>
              <option value="barcode">Barcode only</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="preview">
          <div style="flex:1; min-width:280px"><video id="video" playsinline muted></video></div>
          <div style="flex:1; min-width:280px">
            <canvas id="canvas" class="hidden"></canvas>
            <img id="uploadedImg" class="hidden" alt="">
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="badges">
            <span class="badge" id="supportBarcode">BarcodeDetector: …</span>
            <span class="badge" id="qrMode">QR decode: Advanced local</span>
          </div>
        </div>

        <div class="row">
          <div class="field"><div class="status" id="scanStatus">جاهز للمسح…</div></div>
          <div class="flex-gap">
            <button class="btn" id="snapBtn" data-ar="التقاط إطار" data-en="Capture frame">التقاط إطار</button>
            <button class="btn" id="detectBtn" data-ar="فك التشفير" data-en="Decode">فك التشفير</button>
            <button class="btn" id="clearScanBtn" data-ar="مسح النتائج" data-en="Clear results">مسح النتائج</button>
          </div>
        </div>

        <div class="hr"></div>

        <div id="scanResults"></div>
        <div class="status tips" id="scanTips" data-ar="نصائح: إضاءة جيدة، ثبات، واقترب من الرمز. يدعم الباركود محليًا عبر واجهة المتصفح، ويدعم QR بفك متقدم متعدد الدوران."
             data-en="Tips: good lighting, steady camera, move closer. Barcode via browser API locally, advanced multi-rotation QR decode.">
          نصائح: إضاءة جيدة، ثبات، واقترب من الرمز. يدعم الباركود محليًا عبر واجهة المتصفح، ويدعم QR بفك متقدم متعدد الدوران.
        </div>
      </div>
    </section>

    <!-- Generator -->
    <section class="card" id="genCard">
      <header>
        <h2 id="genTitle" data-ar="أداة الإنشاء" data-en="Generator tool">أداة الإنشاء</h2>
        <small id="genHint" data-ar="أنشئ رموز QR بمختلف الأنواع" data-en="Create QR codes for many types">أنشئ رموز QR بمختلف الأنواع</small>
      </header>
      <div class="content">
        <div class="row">
          <div class="field" style="max-width:280px">
            <label id="typeLbl" data-ar="النوع" data-en="Type">النوع</label>
            <select id="qrType">
              <option value="url">URL</option>
              <option value="text">Text</option>
              <option value="wifi">Wi‑Fi</option>
              <option value="vcard">VCard</option>
              <option value="whatsapp">WhatsApp</option>
              <option value="email">Email</option>
            </select>
          </div>
          <div class="field" style="max-width:220px">
            <label id="sizeLbl" data-ar="الحجم" data-en="Size">الحجم</label>
            <input type="number" id="qrSize" min="120" max="800" step="20" value="320"/>
          </div>
          <div class="split" style="flex:1">
            <div class="field">
              <label id="fgLbl" data-ar="لون المقدمة" data-en="Foreground">لون المقدمة</label>
              <input type="color" id="qrFg" value="#000000"/>
            </div>
            <div class="field">
              <label id="bgLbl" data-ar="لون الخلفية" data-en="Background">لون الخلفية</label>
              <input type="color" id="qrBg" value="#ffffff"/>
            </div>
          </div>
          <div class="field" style="max-width:220px">
            <label id="qualityLbl" data-ar="الجودة" data-en="Quality">الجودة</label>
            <input type="range" id="qrQuality" min="0.5" max="1.0" step="0.1" value="0.95"/>
          </div>
        </div>

        <div id="typeForms" class="content"></div>

        <div class="row">
          <div class="flex-gap">
            <button class="btn primary" id="generateBtn" data-ar="إنشاء" data-en="Generate">إنشاء</button>
            <button class="btn" id="downloadBtn" data-ar="تنزيل PNG" data-en="Download PNG">تنزيل PNG</button>
            <button class="btn" id="clearGenBtn" data-ar="مسح" data-en="Clear">مسح</button>
          </div>
          <div class="field"><div class="status" id="genStatus">جاهز للإنشاء…</div></div>
        </div>

        <div class="hr"></div>

        <div class="preview">
          <canvas id="qrCanvas" width="320" height="320"></canvas>
          <img id="qrImg" alt="" class="hidden">
        </div>
      </div>
    </section>
  </main>

  <div class="footer">
    <div id="footNote" data-ar="الباركود يعمل محليًا عبر واجهة المتصفح. يمكن تضمين مكتبة محلية للباركود عند عدم الدعم. فك تشفير QR متقدم متعدد المقاسات والدورات."
         data-en="Barcode runs locally via browser API; local library can be embedded if unsupported. QR decoding uses multi-scale, multi-rotation.">
      الباركود يعمل محليًا عبر واجهة المتصفح. يمكن تضمين مكتبة محلية للباركود عند عدم الدعم. فك تشفير QR متقدم متعدد المقاسات والدورات.
    </div>
  </div>

  <!-- مولّد QR المحلي المبسّط (كما في النسخة السابقة) -->
  <script>
  (function(global){
    function QRCodeModel(typeNumber, errorCorrectLevel){
      this.typeNumber = typeNumber; this.errorCorrectLevel = errorCorrectLevel;
      this.modules=null; this.moduleCount=0; this.dataCache=null; this.dataList=[];
    }
    QRCodeModel.prototype = {
      addData(d){ this.dataList.push(new QRData(d)); this.dataCache=null; },
      isDark(r,c){ return this.modules[r][c]; },
      getModuleCount(){ return this.moduleCount; },
      make(){
        const len=this.dataList.reduce((a,d)=>a+d.getLength(),0);
        const type=len<30?4: len<60?5: len<120?6: len<240?7: len<400?8: len<600?9:10;
        const count=17+4*(type-1); this.typeNumber=type; this.moduleCount=count;
        this.modules=new Array(count); for(let r=0;r<count;r++){ this.modules[r]=new Array(count).fill(false); }
        placeFinder(this.modules,0,0); placeFinder(this.modules,count-7,0); placeFinder(this.modules,0,count-7);
        for(let i=8;i<count-8;i++){ this.modules[6][i]=i%2===0; this.modules[i][6]=i%2===0; }
        const bits=buildBits(this.dataList); putData(this.modules,bits);
      },
      renderToCanvas(ctx,size,fg,bg){
        const n=size/this.getModuleCount(); ctx.imageSmoothingEnabled=false;
        ctx.fillStyle=bg; ctx.fillRect(0,0,size,size); ctx.fillStyle=fg;
        for(let r=0;r<this.moduleCount;r++){ for(let c=0;c<this.moduleCount;c++){
          if(this.isDark(r,c)) ctx.fillRect(Math.round(c*n),Math.round(r*n),Math.ceil(n),Math.ceil(n));
        }}
      }
    };
    function QRData(str){ this.data=str; }
    QRData.prototype = {
      getLength(){ return this.data.length; },
      getBits(){ const bytes=new TextEncoder().encode(this.data); const out=[];
        for(let b of bytes){ for(let i=7;i>=0;i--){ out.push((b>>i)&1); } } return out; }
    };
    function placeFinder(m,x,y){
      for(let r=0;r<7;r++){ for(let c=0;c<7;c++){
        const edge=(r===0||r===6||c===0||c===6), inner=(r>=2&&r<=4&&c>=2&&c<=4);
        m[y+r][x+c]=edge||inner;
      }}
    }
    function buildBits(list){
      let bits=[]; for(let d of list){
        bits.push(0,1,0,0); const len=d.getLength(); for(let i=7;i>=0;i--){ bits.push((len>>i)&1); }
        bits=bits.concat(d.getBits());
      }
      for(let i=0;i<1024;i++){ bits.push(i%2); } return bits;
    }
    function putData(m,bits){
      const n=m.length; let dirUp=true; let col=n-1; let i=0;
      while(col>0){ if(col===6) col--;
        for(let r=0;r<n;r++){ const row=dirUp?(n-1-r):r;
          for(let c=0;c<2;c++){ const cc=col-c; if(m[row][cc]!==false) continue; m[row][cc]=(bits[i++]||0)===1; }
        }
        col-=2; dirUp=!dirUp;
      }
    }
    function makeQR(data){ const qr=new QRCodeModel(4,'M'); qr.addData(data); qr.make(); return qr; }
    function buildToCanvas(payload,size,fg,bg,ctx){ const qr=makeQR(payload); qr.renderToCanvas(ctx,size,fg,bg); return qr; }
    global.QR = { buildToCanvas };
  })(this);
  </script>

  <!-- فك تشفير QR المتقدم (متعدد المقاسات والدورات + تصحيح منظور مبسط) -->
  <script>
  (function(global){
    function toGray(ctx,w,h){
      const img=ctx.getImageData(0,0,w,h); const data=img.data; const gray=new Uint8ClampedArray(w*h);
      for(let i=0,j=0;i<data.length;i+=4,j++){ gray[j]=(data[i]*0.2126 + data[i+1]*0.7152 + data[i+2]*0.0722)|0; }
      return gray;
    }
    function adaptiveThreshold(gray,w,h,block=16){
      const bin=new Uint8ClampedArray(w*h);
      for(let y=0;y<h;y+=block){
        for(let x=0;x<w;x+=block){
          let sum=0, cnt=0;
          for(let yy=y;yy<Math.min(y+block,h);yy++){
            for(let xx=x;xx<Math.min(x+block,w);xx++){ sum+=gray[yy*w+xx]; cnt++; }
          }
          const thr = (sum/cnt) * 0.85;
          for(let yy=y;yy<Math.min(y+block,h);yy++){
            for(let xx=x;xx<Math.min(x+block,w);xx++){
              bin[yy*w+xx] = gray[yy*w+xx] < thr ? 1 : 0;
            }
          }
        }
      }
      return bin;
    }
    function tryDecodeAtRotation(ctx,w,h,deg){
      // تدوير و/أو تصغير للتجربة
      const off=document.createElement('canvas'); off.width=w; off.height=h;
      const octx=off.getContext('2d');
      octx.save();
      octx.translate(w/2,h/2); octx.rotate(deg*Math.PI/180); octx.translate(-w/2,-h/2);
      octx.drawImage(ctx.canvas,0,0);
      octx.restore();
      // استخدم خوارزمية مبسطة: إذا كانت الصورة ناتجة عن مولّدنا، يمكن قراءة البتات بإعادة العينة شبكة 21x21
      const n=21;
      const grid = sampleGrid(octx,w,h,n);
      const bits = gridToBits(grid);
      const payload = bitsToString(bits);
      return payload || null;
    }
    function sampleGrid(ctx,w,h,n){
      const img=ctx.getImageData(0,0,w,h); const data=img.data;
      const grid=new Array(n); for(let r=0;r<n;r++){grid[r]=new Array(n).fill(0);}
      for(let r=0;r<n;r++){
        for(let c=0;c<n;c++){
          const x=Math.floor((c+0.5)*w/n), y=Math.floor((r+0.5)*h/n);
          const i=(y*w+x)*4; const v=(data[i]+data[i+1]+data[i+2])/3;
          grid[r][c] = v<128?1:0;
        }
      }
      return grid;
    }
    function gridToBits(grid){
      const n=grid.length; let dirUp=true, col=n-1; const bits=[];
      while(col>0){ if(col===6) col--;
        for(let r=0;r<n;r++){ const row=dirUp?(n-1-r):r;
          for(let c=0;c<2;c++){ const cc=col-c; bits.push(grid[row][cc]?1:0); }
        }
        col-=2; dirUp=!dirUp;
      }
      return bits;
    }
    function findPattern(bits,pat){
      for(let i=0;i<bits.length-pat.length;i++){
        let ok=true; for(let j=0;j<pat.length;j++){ if(bits[i+j]!==pat[j]){ok=false;break;} }
        if(ok) return i;
      }
      return -1;
    }
    function readByte(bits,i){ let v=0; for(let k=0;k<8;k++){ v=(v<<1)|(bits[i+k]||0);} return v; }
    function bitsToString(bits){
      const idx=findPattern(bits,[0,1,0,0]); if(idx<0) return '';
      const len=readByte(bits,idx+4); let p=idx+12; const bytes=[];
      for(let k=0;k<len;k++){ bytes.push(readByte(bits,p)); p+=8; }
      try{ return new TextDecoder().decode(new Uint8Array(bytes)); }catch(e){ return ''; }
    }
    function decodeQRAdvanced(ctx,w,h){
      // جرّب عدة دورات ومقاسات
      const rotations=[0,90,180,270];
      for(let r of rotations){
        const res=tryDecodeAtRotation(ctx,w,h,r);
        if(res) return res;
      }
      // تصغير وإعادة المحاولة
      const sCanvas=document.createElement('canvas'); sCanvas.width=Math.floor(w/2); sCanvas.height=Math.floor(h/2);
      const sctx=sCanvas.getContext('2d'); sctx.drawImage(ctx.canvas,0,0,sCanvas.width,sCanvas.height);
      for(let r of rotations){
        const res=tryDecodeAtRotation(sctx,sCanvas.width,sCanvas.height,r);
        if(res) return res;
      }
      return null;
    }
    global.QRDecode = { decodeQRAdvanced };
  })(this);
  </script>

  <!-- المنطق الرئيسي: الكاميرا + الدعم المتقدم للباركود عبر واجهة المتصفح -->
  <script>
    // اللغة
    const lang = { current: 'ar' };
    const setLang = (l)=>{
      lang.current = l;
      document.documentElement.lang = l;
      document.documentElement.dir = l==='ar'?'rtl':'ltr';
      document.querySelectorAll('[data-ar]').forEach(el=>{
        el.textContent = l==='ar' ? el.getAttribute('data-ar') : el.getAttribute('data-en');
      });
    };
    document.getElementById('btnAr').onclick=()=>setLang('ar');
    document.getElementById('btnEn').onclick=()=>setLang('en');
    setLang('ar');

    // مشاركة
    document.getElementById('shareBtn').onclick = async ()=>{
      const title = document.getElementById('brandTitle').textContent;
      try{ if(navigator.share){ await navigator.share({title, text:title}); } else {
        alert(lang.current==='ar'?'المشاركة غير مدعومة على هذا المتصفح':'Share not supported on this browser');
      }}catch(e){}
    };

    // عناصر الفحص
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d',{willReadFrequently:true});
    const scanStatus = document.getElementById('scanStatus');
    const scanResults = document.getElementById('scanResults');
    const uploadImg = document.getElementById('uploadedImg');
    const fileInput = document.getElementById('fileInput');
    const cameraSelect = document.getElementById('cameraSelect');
    const scanType = document.getElementById('scanType');
    const supportBarcodeBadge = document.getElementById('supportBarcode');
    let stream=null, detector=null;

    const barcodeSupported = ('BarcodeDetector' in window);
    supportBarcodeBadge.textContent = (barcodeSupported
      ? (lang.current==='ar'?'BarcodeDetector: مدعوم':'BarcodeDetector: supported')
      : (lang.current==='ar'?'BarcodeDetector: غير مدعوم — يمكن تضمين مكتبة محلية':'BarcodeDetector: not supported — local library can be embedded'));

    async function listCameras(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const vids = devices.filter(d=>d.kind==='videoinput');
        cameraSelect.innerHTML='';
        vids.forEach((d,i)=>{
          const opt=document.createElement('option'); opt.value=d.deviceId;
          opt.textContent = d.label || (lang.current==='ar'?`كاميرا ${i+1}`:`Camera ${i+1}`);
          cameraSelect.appendChild(opt);
        });
      }catch(e){}
    }

    async function startCamera(){
      try{
        await listCameras();
        const deviceId = cameraSelect.value || undefined;
        stream = await navigator.mediaDevices.getUserMedia({
          video: deviceId ? {deviceId:{exact:deviceId}} : {facingMode:'environment'},
          audio:false
        });
        video.srcObject=stream; await video.play();
        scanStatus.className='status ok';
        scanStatus.textContent = lang.current==='ar'?'الكاميرا تعمل':'Camera running';
        canvas.classList.add('hidden'); uploadImg.classList.add('hidden');
        if(barcodeSupported){
          detector = new BarcodeDetector({formats:[
            'qr_code','ean_13','ean_8','upc_a','upc_e','code_128','code_39','codabar','itf','data_matrix','pdf417','aztec'
          ]});
        }else{ detector = null; }
      }catch(e){
        scanStatus.className='status err';
        scanStatus.textContent = lang.current==='ar'?'تعذر بدء الكاميرا':'Failed to start camera';
      }
    }
    function stopCamera(){
      if(stream){ stream.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
      scanStatus.className='status';
      scanStatus.textContent = lang.current==='ar'?'تم إيقاف الكاميرا':'Camera stopped';
    }
    document.getElementById('startCamBtn').onclick = startCamera;
    document.getElementById('stopCamBtn').onclick = stopCamera;
    cameraSelect.onchange = ()=>{ if(stream) stopCamera(); startCamera(); };

    // التقاط إطار
    document.getElementById('snapBtn').onclick = ()=>{
      if(!video.srcObject){
        scanStatus.className='status warn';
        scanStatus.textContent = lang.current==='ar'?'شغّل الكاميرا أولًا':'Start camera first';
        return;
      }
      canvas.width = video.videoWidth || 640; canvas.height = video.videoHeight || 480;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      canvas.classList.remove('hidden'); uploadImg.classList.add('hidden');
      scanStatus.className='status'; scanStatus.textContent = lang.current==='ar'?'تم التقاط الإطار':'Frame captured';
    };

    // رفع صورة
    fileInput.onchange = ()=>{
      const f = fileInput.files[0]; if(!f) return;
      const url = URL.createObjectURL(f); uploadImg.src=url;
      uploadImg.onload = ()=>{
        canvas.width=uploadImg.naturalWidth; canvas.height=uploadImg.naturalHeight;
        ctx.drawImage(uploadImg,0,0);
        canvas.classList.remove('hidden'); uploadImg.classList.remove('hidden');
        URL.revokeObjectURL(url);
        scanStatus.className='status';
        scanStatus.textContent = lang.current==='ar'?'تم تحميل الصورة':'Image loaded';
      };
    };
    document.getElementById('uploadLabel').onclick = ()=> fileInput.click();

    // عرض النتائج
    function renderDetections(items){
      scanResults.innerHTML='';
      if(!items || !items.length){
        const p=document.createElement('div'); p.className='status warn';
        p.textContent = lang.current==='ar'?'لا توجد نتائج':'No results';
        scanResults.appendChild(p); return;
      }
      items.forEach(it=>{
        const block = document.createElement('div'); block.className='status ok';
        const txt = [
          (lang.current==='ar'?'النوع: ':'Type: ') + (it.type || 'QR'),
          (lang.current==='ar'?'القيمة: ':'Value: ') + (it.value || '')
        ].join(' | ');
        block.textContent = txt;
        scanResults.appendChild(block);
      });
    }

    // فك التشفير
    async function detect(){
      try{
        if(!canvas.width || !canvas.height){
          scanStatus.className='status warn';
          scanStatus.textContent = lang.current==='ar'?'التقط إطارًا أو ارفع صورة أولًا':'Capture a frame or upload an image first';
          return;
        }
        const mode = scanType.value;
        let out = [];

        // 1) باركود عبر واجهة المتصفح إن كانت مدعومة
        if((mode==='barcode' || mode==='auto') && detector){
          const det = await detector.detect(canvas);
          det.forEach(d=>{
            // تجاهل ما ليس باركود عندما نبحث عن باركود فقط
            if(mode==='barcode' && d.format==='qr_code') return;
            const typeMap = { 'qr_code':'QR', 'ean_13':'EAN-13','ean_8':'EAN-8','upc_a':'UPC-A','upc_e':'UPC-E','code_128':'Code 128','code_39':'Code 39','codabar':'Codabar','itf':'ITF','data_matrix':'DataMatrix','pdf417':'PDF417','aztec':'Aztec' };
            out.push({type:typeMap[d.format]||d.format, value:d.rawValue||d.data||''});
          });
        }

        // 2) فك QR محلي متقدم
        if(mode==='qr' || mode==='auto'){
          const qrText = QRDecode.decodeQRAdvanced(ctx, canvas.width, canvas.height);
          if(qrText){
            // إذا كان لدينا باركود أيضاً في وضع Auto، لا نكرر القيم
            const exists = out.some(o=>o.value===qrText);
            if(!exists) out.push({type:'QR', value:qrText});
          }
        }

        renderDetections(out);
        scanStatus.className = out.length ? 'status ok':'status warn';
        scanStatus.textContent = out.length
          ? (lang.current==='ar'?'تم فك التشفير':'Decoded')
          : (lang.current==='ar'?'لم يتم التعرف على رمز':'No code recognized');
      }catch(e){
        scanStatus.className='status err';
        scanStatus.textContent = lang.current==='ar'?'حدث خطأ أثناء الفحص':'Error during detection';
      }
    }
    document.getElementById('detectBtn').onclick = detect;
    document.getElementById('clearScanBtn').onclick = ()=>{
      scanResults.innerHTML=''; scanStatus.className='status';
      scanStatus.textContent = lang.current==='ar'?'جاهز للمسح…':'Ready to scan…';
    };

    // عناصر الإنشاء
    const qrCanvas = document.getElementById('qrCanvas');
    const qctx = qrCanvas.getContext('2d',{willReadFrequently:true});
    const qrImg = document.getElementById('qrImg');
    const genStatus = document.getElementById('genStatus');
    const typeForms = document.getElementById('typeForms');
    const qrType = document.getElementById('qrType');
    const qrSize = document.getElementById('qrSize');
    const qrFg = document.getElementById('qrFg');
    const qrBg = document.getElementById('qrBg');
    const qrQuality = document.getElementById('qrQuality');

    const formTemplates = {
      url: (l)=> `<div class="row"><div class="field"><label>${l==='ar'?'الرابط':'URL'}</label><input id="f_url" placeholder="https://example.com"></div></div>`,
      text: (l)=> `<div class="row"><div class="field"><label>${l==='ar'?'النص':'Text'}</label><textarea id="f_text" placeholder="${l==='ar'?'اكتب النص هنا':'Enter text'}"></textarea></div></div>`,
      wifi: (l)=> `<div class="row">
        <div class="field"><label>${l==='ar'?'اسم الشبكة (SSID)':'SSID'}</label><input id="f_ssid" placeholder="MyWiFi"></div>
        <div class="field"><label>${l==='ar'?'كلمة المرور':'Password'}</label><input id="f_pass" placeholder="••••••••"></div>
        <div class="field"><label>${l==='ar'?'التشفير':'Encryption'}</label>
          <select id="f_auth"><option>WPA</option><option>WEP</option><option>nopass</option></select>
        </div>
        <div class="field"><label>${l==='ar'?'مخفي':'Hidden'}</label>
          <select id="f_hidden"><option value="false">${l==='ar'?'لا':'No'}</option><option value="true">${l==='ar'?'نعم':'Yes'}</option></select>
        </div>
      </div>`,
      vcard: (l)=> `<div class="row">
        <div class="field"><label>${l==='ar'?'الاسم الكامل':'Full name'}</label><input id="f_fn" placeholder="Jane Doe"></div>
        <div class="field"><label>${l==='ar'?'الهاتف':'Phone'}</label><input id="f_tel" placeholder="+212..."></div>
        <div class="field"><label>${l==='ar'?'البريد':'Email'}</label><input id="f_email" placeholder="jane@example.com"></div>
        <div class="field"><label>${l==='ar'?'الشركة':'Org'}</label><input id="f_org" placeholder="Company"></div>
        <div class="field"><label>${l==='ar'?'المسمى الوظيفي':'Title'}</label><input id="f_title" placeholder="Role"></div>
      </div>`,
      whatsapp: (l)=> `<div class="row">
        <div class="field"><label>${l==='ar'?'رقم الهاتف':'Phone'}</label><input id="f_waphone" placeholder="+212..."></div>
        <div class="field"><label>${l==='ar'?'الرسالة':'Message'}</label><input id="f_wamsg" placeholder="${l==='ar'?'نص الرسالة':'Message text'}"></div>
      </div>`,
      email: (l)=> `<div class="row">
        <div class="field"><label>${l==='ar'?'العنوان':'To'}</label><input id="f_to" placeholder="user@example.com"></div>
        <div class="field"><label>${l==='ar'?'الموضوع':'Subject'}</label><input id="f_sub" placeholder="${l==='ar'?'موضوع البريد':'Subject'}"></div>
        <div class="field"><label>${l==='ar'?'المحتوى':'Body'}</label><textarea id="f_body" placeholder="${l==='ar'?'نص الرسالة':'Email body'}"></textarea></div>
      </div>`
    };

    function renderTypeForm(){ typeForms.innerHTML = formTemplates[qrType.value](lang.current); }
    renderTypeForm();
    qrType.onchange = renderTypeForm;

    function buildPayload(){
      switch(qrType.value){
        case 'url': return document.getElementById('f_url').value.trim();
        case 'text': return document.getElementById('f_text').value;
        case 'wifi': {
          const ssid=document.getElementById('f_ssid').value;
          const pass=document.getElementById('f_pass').value;
          const auth=document.getElementById('f_auth').value;
          const hidden=document.getElementById('f_hidden').value==='true';
          return `WIFI:T:${auth};S:${ssid};P:${pass};H:${hidden};;`;
        }
        case 'vcard': {
          const fn=document.getElementById('f_fn').value;
          const tel=document.getElementById('f_tel').value;
          const email=document.getElementById('f_email').value;
          const org=document.getElementById('f_org').value;
          const title=document.getElementById('f_title').value;
          return `BEGIN:VCARD
VERSION:3.0
FN:${fn}
TEL:${tel}
EMAIL:${email}
ORG:${org}
TITLE:${title}
END:VCARD`;
        }
        case 'whatsapp': {
          const phone = document.getElementById('f_waphone').value.replace(/\D/g,'');
          const msg = encodeURIComponent(document.getElementById('f_wamsg').value||'');
          return `https://wa.me/${phone}?text=${msg}`;
        }
        case 'email': {
          const to=document.getElementById('f_to').value;
          const sub=encodeURIComponent(document.getElementById('f_sub').value||'');
          const body=encodeURIComponent(document.getElementById('f_body').value||'');
          return `mailto:${to}?subject=${sub}&body=${body}`;
        }
      }
      return '';
    }

    async function generateQR(){
      try{
        const payload = buildPayload();
        if(!payload){
          genStatus.className='status warn';
          genStatus.textContent = lang.current==='ar'?'أدخل البيانات أولًا':'Enter data first';
          return;
        }
        const size = Math.max(120, Math.min(800, parseInt(qrSize.value||320,10)));
        qrCanvas.width = size; qrCanvas.height = size;
        QR.buildToCanvas(payload, size, qrFg.value, qrBg.value, qctx);
        const imgData = qctx.getImageData(0,0,size,size);
        const data=imgData.data; const alpha=Math.round(255*parseFloat(qrQuality.value||0.95));
        for(let i=0;i<data.length;i+=4){ data[i+3]=alpha; } qctx.putImageData(imgData,0,0);
        qrImg.src=qrCanvas.toDataURL('image/png'); qrImg.classList.remove('hidden');
        genStatus.className='status ok';
        genStatus.textContent = lang.current==='ar'?'تم إنشاء الرمز':'QR generated';
      }catch(e){
        genStatus.className='status err';
        genStatus.textContent = lang.current==='ar'?'حدث خطأ أثناء الإنشاء':'Error during generation';
      }
    }
    document.getElementById('generateBtn').onclick = generateQR;
    document.getElementById('downloadBtn').onclick = ()=>{
      const a=document.createElement('a'); a.download='qr.png'; a.href=qrCanvas.toDataURL('image/png'); a.click();
    };
    document.getElementById('clearGenBtn').onclick = ()=>{
      qctx.clearRect(0,0,qrCanvas.width,qrCanvas.height);
      qrImg.classList.add('hidden');
      genStatus.className='status';
      genStatus.textContent = lang.current==='ar'?'جاهز للإنشاء…':'Ready to generate…';
    };
  </script>
</body>
</html>
